<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noindex, nofollow">
  <title>Site Audit Tool ‚Äî IYS</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: Inter, sans-serif; background: #f1f5f9; color: #0f172a; font-size: 15px; line-height: 1.5; }

    /* ‚îÄ‚îÄ Login ‚îÄ‚îÄ */
    #login-screen {
      min-height: 100vh; display: flex; align-items: center;
      justify-content: center; padding: 2rem; background: #0f172a;
    }
    .login-card {
      background: #1e293b; border: 1px solid #334155; border-radius: 20px;
      padding: 2.5rem 2rem; width: 100%; max-width: 360px; text-align: center; color: #e2e8f0;
    }
    .login-card h1 { font-size: 1.2rem; margin: 0 0 .3rem; }
    .login-card p { color: #64748b; font-size: .85rem; margin: 0 0 1.4rem; }
    .login-card input[type="password"] {
      width: 100%; padding: .7rem 1rem; background: #0f172a; border: 1.5px solid #334155;
      border-radius: 10px; color: #e2e8f0; font-size: 1rem; font-family: Inter, sans-serif;
      margin-bottom: .75rem;
    }
    .login-card input:focus { outline: none; border-color: #5b4dff; }
    .btn-login {
      width: 100%; padding: .75rem; background: #5b4dff; color: #fff; border: none;
      border-radius: 10px; font-size: 1rem; font-weight: 700; cursor: pointer; font-family: Inter, sans-serif;
    }
    .btn-login:hover { background: #4c40db; }
    .login-error { color: #f87171; font-size: .82rem; margin-top: .5rem; display: none; }

    /* ‚îÄ‚îÄ App ‚îÄ‚îÄ */
    #app { display: none; min-height: 100vh; }

    /* ‚îÄ‚îÄ Tool header ‚îÄ‚îÄ */
    .tool-header {
      background: #0f172a; padding: .75rem 1.5rem; display: flex;
      align-items: center; justify-content: space-between; gap: 1rem; flex-wrap: wrap;
      position: sticky; top: 0; z-index: 100; border-bottom: 2px solid #5b4dff;
    }
    .tool-logo { color: #fff; font-weight: 800; font-size: 1rem; display: flex; align-items: center; gap: .5rem; }
    .tool-logo span { color: #2dd4bf; }
    .tool-badge {
      background: #5b4dff; color: #fff; font-size: .67rem; font-weight: 800;
      padding: .18rem .55rem; border-radius: 999px; text-transform: uppercase; letter-spacing: .07em;
    }
    .btn-logout {
      background: #1e293b; color: #64748b; border: 1px solid #334155; border-radius: 7px;
      padding: .28rem .75rem; font-size: .76rem; font-weight: 600; cursor: pointer; font-family: Inter, sans-serif;
    }
    .btn-logout:hover { color: #94a3b8; }

    /* ‚îÄ‚îÄ Audit form ‚îÄ‚îÄ */
    .audit-form-section {
      background: #fff; border-bottom: 1px solid #e2e8f0; padding: 1.25rem 1.5rem;
    }
    .audit-form {
      display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: .75rem; max-width: 900px;
    }
    .audit-input {
      padding: .65rem 1rem; border: 1.5px solid #e2e8f0; border-radius: 10px;
      font-family: Inter, sans-serif; font-size: .9rem; color: #0f172a; background: #f8fafc;
    }
    .audit-input:focus { outline: none; border-color: #5b4dff; background: #fff; }
    .btn-audit {
      padding: .65rem 1.4rem; background: linear-gradient(135deg, #5b4dff, #4c40db);
      color: #fff; border: none; border-radius: 10px; font-size: .9rem; font-weight: 800;
      cursor: pointer; font-family: Inter, sans-serif; white-space: nowrap;
      box-shadow: 0 4px 14px rgba(91,77,255,.3);
    }
    .btn-audit:hover { background: linear-gradient(135deg, #4c40db, #3d33b8); }
    .btn-audit:disabled { opacity: .6; cursor: not-allowed; }
    @media (max-width: 700px) { .audit-form { grid-template-columns: 1fr; } }

    /* ‚îÄ‚îÄ API key hint ‚îÄ‚îÄ */
    .api-hint { font-size: .78rem; color: #94a3b8; margin-top: .5rem; }
    .api-hint a { color: #5b4dff; }

    /* ‚îÄ‚îÄ Loading ‚îÄ‚îÄ */
    #loading {
      display: none; padding: 4rem 1.5rem; text-align: center;
    }
    .spinner {
      width: 44px; height: 44px; border: 3px solid #e2e8f0;
      border-top-color: #5b4dff; border-radius: 50%;
      animation: spin .8s linear infinite; margin: 0 auto 1.25rem;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .loading-status { color: #64748b; font-size: .95rem; }
    .loading-url { color: #0f172a; font-weight: 700; margin-top: .25rem; font-size: .9rem; }

    /* ‚îÄ‚îÄ Error banner ‚îÄ‚îÄ */
    .error-banner {
      display: none; background: #fef2f2; border: 1px solid #fecaca; border-radius: 12px;
      padding: 1rem 1.25rem; margin: 1.5rem; color: #991b1b; font-size: .9rem;
    }

    /* ‚îÄ‚îÄ Results ‚îÄ‚îÄ */
    #results { display: none; padding: 1.5rem; max-width: 980px; margin: 0 auto; }

    .result-meta {
      display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;
      margin-bottom: 1.25rem; background: #fff; border: 1px solid #e2e8f0;
      border-radius: 12px; padding: .85rem 1.1rem; font-size: .85rem; color: #64748b;
    }
    .result-meta strong { color: #0f172a; }
    .result-meta a { color: #5b4dff; text-decoration: none; font-weight: 600; }
    .result-meta a:hover { text-decoration: underline; }

    /* ‚îÄ‚îÄ Scores ‚îÄ‚îÄ */
    .scores-grid {
      display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 1rem;
    }
    @media (max-width: 600px) { .scores-grid { grid-template-columns: repeat(2, 1fr); } }
    .score-card {
      background: #fff; border: 1px solid #e2e8f0; border-radius: 16px;
      padding: 1.25rem 1rem; text-align: center; position: relative; overflow: hidden;
    }
    .score-card::before {
      content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px;
      background: var(--score-color, #e2e8f0);
    }
    .score-label { font-size: .72rem; font-weight: 700; text-transform: uppercase; letter-spacing: .06em; color: #94a3b8; margin-bottom: .5rem; }
    .score-num { font-size: 2.8rem; font-weight: 900; color: var(--score-color, #94a3b8); line-height: 1; margin-bottom: .3rem; }
    .score-target { font-size: .73rem; color: #94a3b8; }
    .score-delta { font-size: .78rem; font-weight: 700; margin-top: .2rem; }

    /* ‚îÄ‚îÄ Vitals ‚îÄ‚îÄ */
    .panel { background: #fff; border: 1px solid #e2e8f0; border-radius: 16px; padding: 1.25rem 1.4rem; margin-bottom: 1rem; }
    .panel-title { font-size: .8rem; font-weight: 800; text-transform: uppercase; letter-spacing: .07em; color: #94a3b8; margin-bottom: 1rem; }
    .vitals-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: .65rem; }
    @media (max-width: 500px) { .vitals-grid { grid-template-columns: 1fr; } }
    .vital-item {
      display: flex; align-items: center; justify-content: space-between;
      background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 10px; padding: .7rem .9rem;
    }
    .vital-name { font-size: .82rem; font-weight: 600; color: #374151; }
    .vital-desc { font-size: .72rem; color: #94a3b8; }
    .vital-right { text-align: right; }
    .vital-value { font-size: 1.1rem; font-weight: 800; color: var(--vital-color, #0f172a); }
    .vital-status { font-size: .7rem; font-weight: 700; }
    .pass { color: #16a34a; }
    .warn { color: #d97706; }
    .fail { color: #dc2626; }

    /* ‚îÄ‚îÄ Issues checklist ‚îÄ‚îÄ */
    .issues-list { display: flex; flex-direction: column; gap: .45rem; }
    .issue-item {
      display: flex; align-items: flex-start; gap: .75rem;
      padding: .65rem .85rem; border-radius: 10px; font-size: .88rem;
    }
    .issue-item.ok { background: #f0fdf4; }
    .issue-item.bad { background: #fff7ed; }
    .issue-item.warn-item { background: #fffbeb; }
    .issue-icon { flex-shrink: 0; font-size: 1rem; margin-top: .05rem; }
    .issue-text { flex: 1; color: #374151; }
    .issue-text strong { color: #0f172a; display: block; margin-bottom: .1rem; }
    .issue-text span { font-size: .8rem; color: #64748b; }

    /* ‚îÄ‚îÄ Revenue impact ‚îÄ‚îÄ */
    .revenue-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
    @media (max-width: 500px) { .revenue-grid { grid-template-columns: 1fr; } }
    .revenue-input-group { display: flex; flex-direction: column; gap: .5rem; }
    .revenue-input-group label { font-size: .82rem; font-weight: 600; color: #374151; }
    .revenue-input {
      padding: .55rem .85rem; border: 1.5px solid #e2e8f0; border-radius: 8px;
      font-family: Inter, sans-serif; font-size: .9rem; background: #f8fafc;
    }
    .revenue-input:focus { outline: none; border-color: #5b4dff; }
    .revenue-result {
      background: linear-gradient(135deg, #f0f4ff, #f0fdf9); border: 1.5px solid #c7d2fe;
      border-radius: 14px; padding: 1.25rem; text-align: center; display: flex;
      flex-direction: column; justify-content: center;
    }
    .revenue-label { font-size: .78rem; color: #64748b; margin-bottom: .35rem; }
    .revenue-number { font-size: 2.2rem; font-weight: 900; color: #5b4dff; line-height: 1; }
    .revenue-period { font-size: .78rem; color: #94a3b8; margin-top: .25rem; }
    .btn-calc {
      margin-top: .75rem; padding: .55rem 1.1rem; background: #5b4dff; color: #fff;
      border: none; border-radius: 8px; font-size: .85rem; font-weight: 700;
      cursor: pointer; font-family: Inter, sans-serif;
    }

    /* ‚îÄ‚îÄ Notes & package rec ‚îÄ‚îÄ */
    .notes-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
    @media (max-width: 600px) { .notes-grid { grid-template-columns: 1fr; } }
    .notes-grid textarea {
      width: 100%; padding: .75rem 1rem; border: 1.5px solid #e2e8f0; border-radius: 10px;
      font-family: Inter, sans-serif; font-size: .88rem; resize: vertical; min-height: 110px;
      background: #f8fafc; color: #0f172a;
    }
    .notes-grid textarea:focus { outline: none; border-color: #5b4dff; }
    .pkg-select-wrap { display: flex; flex-direction: column; gap: .75rem; }
    .pkg-select-wrap label { font-size: .82rem; font-weight: 600; color: #374151; }
    .pkg-select {
      padding: .65rem 1rem; border: 1.5px solid #e2e8f0; border-radius: 10px;
      font-family: Inter, sans-serif; font-size: .9rem; background: #f8fafc; color: #0f172a;
    }
    .pkg-select:focus { outline: none; border-color: #5b4dff; }

    /* ‚îÄ‚îÄ Talking points ‚îÄ‚îÄ */
    .talking-points { display: flex; flex-direction: column; gap: .6rem; }
    .tp-item {
      background: #f8f7ff; border: 1px solid #e0e7ff; border-left: 3px solid #5b4dff;
      border-radius: 0 10px 10px 0; padding: .75rem 1rem;
    }
    .tp-item.critical { border-left-color: #dc2626; background: #fff5f5; border-color: #fecaca; }
    .tp-item.high { border-left-color: #f59e0b; background: #fffbeb; border-color: #fde68a; }
    .tp-cat { font-size: .7rem; font-weight: 800; text-transform: uppercase; letter-spacing: .06em; color: #5b4dff; margin-bottom: .2rem; }
    .tp-item.critical .tp-cat { color: #dc2626; }
    .tp-item.high .tp-cat { color: #d97706; }
    .tp-text { font-size: .88rem; color: #374151; line-height: 1.55; }

    /* ‚îÄ‚îÄ Action bar ‚îÄ‚îÄ */
    .action-bar {
      display: flex; gap: .75rem; flex-wrap: wrap; margin-top: 1rem; margin-bottom: 1rem;
    }
    .btn-action {
      padding: .6rem 1.1rem; border-radius: 10px; font-size: .85rem; font-weight: 700;
      cursor: pointer; font-family: Inter, sans-serif; border: none; transition: all .15s;
    }
    .btn-save { background: #5b4dff; color: #fff; }
    .btn-save:hover { background: #4c40db; }
    .btn-implement {
      padding: .28rem .85rem; border-radius: 7px; font-size: .76rem; font-weight: 700;
      cursor: pointer; border: none; background: linear-gradient(135deg, #5b4dff, #2dd4bf);
      color: #fff; font-family: Inter, sans-serif; white-space: nowrap; letter-spacing: .01em;
    }
    .btn-implement:hover { opacity: .88; }
    .btn-print { background: #f1f5f9; color: #334155; border: 1.5px solid #e2e8f0; }
    .btn-print:hover { background: #e2e8f0; }
    .btn-copy { background: #f1f5f9; color: #334155; border: 1.5px solid #e2e8f0; }
    .btn-copy:hover { background: #e2e8f0; }
    .save-confirm { font-size: .8rem; color: #16a34a; font-weight: 600; display: none; }

    /* ‚îÄ‚îÄ History ‚îÄ‚îÄ */
    #history-section { max-width: 980px; margin: 0 auto 2rem; padding: 0 1.5rem; }
    .history-title { font-size: .8rem; font-weight: 800; text-transform: uppercase; letter-spacing: .07em; color: #94a3b8; margin-bottom: .75rem; }
    .history-list { display: flex; flex-direction: column; gap: .5rem; }
    .history-item {
      background: #fff; border: 1px solid #e2e8f0; border-radius: 12px;
      padding: .75rem 1rem; display: flex; align-items: center; justify-content: space-between;
      gap: 1rem; flex-wrap: wrap; cursor: pointer; transition: border-color .15s;
    }
    .history-item:hover { border-color: #5b4dff; }
    .history-url { font-size: .88rem; font-weight: 700; color: #0f172a; }
    .history-meta { font-size: .78rem; color: #94a3b8; }
    .history-scores { display: flex; gap: .4rem; }
    .hs { font-size: .72rem; font-weight: 800; padding: .15rem .4rem; border-radius: 5px; }
    .hs-red { background: #fee2e2; color: #dc2626; }
    .hs-amber { background: #fef3c7; color: #d97706; }
    .hs-green { background: #dcfce7; color: #16a34a; }
    .btn-del { background: none; border: none; color: #cbd5e1; cursor: pointer; font-size: 1rem; padding: .1rem .3rem; }
    .btn-del:hover { color: #dc2626; }

    /* ‚îÄ‚îÄ Strategy note ‚îÄ‚îÄ */
    .strategy-note {
      background: #f0f4ff; border: 1px solid #c7d2fe; border-left: 3px solid #5b4dff;
      border-radius: 0 12px 12px 0; padding: .85rem 1rem; margin-top: 1rem;
      font-size: .82rem; color: #374151; line-height: 1.6;
    }
    .strategy-note strong { color: #3730a3; display: block; margin-bottom: .2rem; }

    /* ‚îÄ‚îÄ Presentation mode ‚îÄ‚îÄ */
    .btn-pres {
      padding: .28rem .75rem; border-radius: 7px; font-size: .76rem; font-weight: 700;
      cursor: pointer; border: 1.5px solid #5b4dff; background: transparent; color: #5b4dff;
      font-family: Inter, sans-serif; transition: all .15s;
    }
    .btn-pres:hover, body.pres-mode .btn-pres { background: #5b4dff; color: #fff; }
    body.pres-mode .api-hint,
    body.pres-mode #history-section,
    body.pres-mode .action-bar,
    body.pres-mode .panel-internal,
    body.pres-mode .btn-logout { display: none !important; }
    body.pres-mode .audit-form-section { display: none; }
    body.pres-mode .score-num { font-size: 3.4rem; }
    body.pres-mode .panel { padding: 1.5rem 1.75rem; }
    body.pres-mode #results { padding: 1.75rem 2rem; }

    /* ‚îÄ‚îÄ Improvements table ‚îÄ‚îÄ */
    .improvements-table { width: 100%; border-collapse: collapse; font-size: .88rem; }
    .improvements-table th {
      text-align: left; padding: .5rem .75rem; font-size: .72rem; font-weight: 800;
      text-transform: uppercase; letter-spacing: .07em; color: #94a3b8;
      border-bottom: 2px solid #f1f5f9;
    }
    .improvements-table td {
      padding: .65rem .75rem; border-bottom: 1px solid #f8fafc; vertical-align: top;
    }
    .improvements-table tr:last-child td { border-bottom: none; }
    .imp-issue { color: #64748b; }
    .imp-fix { color: #0f172a; font-weight: 600; }
    .imp-outcome { color: #16a34a; font-weight: 600; }
    .imp-priority {
      display: inline-block; font-size: .68rem; font-weight: 800; padding: .12rem .45rem;
      border-radius: 999px; text-transform: uppercase; letter-spacing: .05em;
    }
    .imp-critical { background: #fee2e2; color: #dc2626; }
    .imp-high { background: #fef3c7; color: #d97706; }
    .imp-medium { background: #eff6ff; color: #2563eb; }
    @media (max-width: 600px) {
      .improvements-table thead { display: none; }
      .improvements-table td { display: block; padding: .3rem .5rem; }
      .improvements-table tr { display: block; background: #f8fafc; border-radius: 10px; margin-bottom: .5rem; padding: .3rem; }
    }

    /* ‚îÄ‚îÄ Proposal card ‚îÄ‚îÄ */
    .proposal-card {
      background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 100%);
      border-radius: 20px; padding: 2rem; color: #fff; margin-bottom: 1rem;
    }
    .proposal-header {
      display: flex; align-items: flex-start; justify-content: space-between;
      gap: 1rem; flex-wrap: wrap; margin-bottom: 1.5rem;
    }
    .proposal-eyebrow { font-size: .72rem; font-weight: 800; text-transform: uppercase; letter-spacing: .08em; color: #2dd4bf; margin-bottom: .4rem; }
    .proposal-pkg-name { font-size: 1.6rem; font-weight: 900; color: #fff; }
    .proposal-timeline {
      background: rgba(45,212,191,.15); border: 1px solid rgba(45,212,191,.3);
      color: #2dd4bf; font-size: .85rem; font-weight: 700; padding: .5rem 1rem;
      border-radius: 10px; white-space: nowrap; align-self: flex-start;
    }
    .proposal-ba {
      display: grid; grid-template-columns: 1fr auto 1fr; gap: 1.25rem;
      align-items: start; margin-bottom: 1.5rem;
    }
    @media (max-width: 580px) { .proposal-ba { grid-template-columns: 1fr; } }
    .ba-col-label {
      font-size: .7rem; font-weight: 800; text-transform: uppercase; letter-spacing: .07em;
      margin-bottom: .6rem;
    }
    .ba-col-label.before { color: #f87171; }
    .ba-col-label.after  { color: #2dd4bf; }
    .ba-row {
      display: flex; align-items: center; gap: .5rem; font-size: .88rem;
      padding: .3rem 0; border-bottom: 1px solid rgba(255,255,255,.06);
    }
    .ba-row:last-child { border-bottom: none; }
    .ba-arrow-col { text-align: center; font-size: 1.5rem; color: rgba(255,255,255,.3); padding-top: 1.5rem; }
    .proposal-includes {
      display: grid; grid-template-columns: repeat(3, 1fr); gap: .45rem .75rem;
      margin-top: 1.25rem; padding-top: 1.25rem; border-top: 1px solid rgba(255,255,255,.1);
    }
    @media (max-width: 580px) { .proposal-includes { grid-template-columns: 1fr 1fr; } }
    .prop-inc { font-size: .82rem; color: rgba(255,255,255,.8); display: flex; gap: .4rem; align-items: flex-start; }
    .prop-inc span { color: #2dd4bf; font-weight: 800; flex-shrink: 0; }

    /* ‚îÄ‚îÄ CrUX panel ‚îÄ‚îÄ */
    .crux-note {
      background: #f8f7ff; border: 1px solid #e0e7ff; border-radius: 10px;
      padding: .65rem 1rem; margin-bottom: .85rem; font-size: .82rem; color: #374151;
    }
    .crux-metric {
      display: flex; align-items: center; justify-content: space-between;
      background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 10px; padding: .7rem .9rem;
    }
    .crux-source { font-size: .68rem; color: #94a3b8; margin-top: .3rem; }

    /* ‚îÄ‚îÄ Site Intelligence ‚îÄ‚îÄ */
    .intel-grid {
      display: grid; grid-template-columns: repeat(2, 1fr); gap: .65rem; margin-bottom: .85rem;
    }
    @media (max-width: 540px) { .intel-grid { grid-template-columns: 1fr; } }
    .intel-item {
      display: flex; align-items: flex-start; gap: .55rem; padding: .6rem .8rem;
      border-radius: 10px; font-size: .84rem;
    }
    .intel-ok  { background: #f0fdf4; }
    .intel-bad { background: #fff7ed; }
    .intel-neu { background: #f8fafc; border: 1px solid #e2e8f0; }
    .intel-label { font-weight: 700; color: #0f172a; display: block; margin-bottom: .1rem; }
    .intel-value { color: #374151; font-size: .8rem; word-break: break-word; }
    .platform-badge {
      display: inline-block; padding: .2rem .65rem; border-radius: 999px; font-size: .72rem;
      font-weight: 800; text-transform: uppercase; letter-spacing: .05em;
      background: #fee2e2; color: #dc2626; margin-bottom: .6rem;
    }
    .platform-note {
      font-size: .82rem; color: #374151; line-height: 1.55;
      background: #fff5f5; border: 1px solid #fecaca; border-left: 3px solid #dc2626;
      border-radius: 0 10px 10px 0; padding: .65rem .9rem; margin-bottom: .85rem;
    }
    .platform-note.neutral { background: #f8fafc; border-color: #e2e8f0; border-left-color: #94a3b8; }
    .sb-badge {
      display: inline-flex; align-items: center; gap: .35rem; font-size: .78rem; font-weight: 700;
      padding: .2rem .6rem; border-radius: 999px;
    }
    .sb-clean   { background: #dcfce7; color: #16a34a; }
    .sb-flagged { background: #fee2e2; color: #dc2626; }
    .sb-unknown { background: #f1f5f9; color: #94a3b8; }

    /* ‚îÄ‚îÄ Print ‚îÄ‚îÄ */
    @media print {
      .tool-header, .audit-form-section, .action-bar, #history-section,
      .btn-logout, .btn-del, #loading, .panel-internal { display: none !important; }
      #app { display: block !important; }
      #results { display: block !important; padding: 0; }
      body { background: #fff; }
      .panel, .score-card, .proposal-card { break-inside: avoid; }
    }
  </style>
</head>
<body>

<!-- ‚îÄ‚îÄ Login ‚îÄ‚îÄ -->
<div id="login-screen">
  <div class="login-card">
    <div style="font-size:1.6rem;margin-bottom:.4rem">üîç</div>
    <h1>Site Audit Tool</h1>
    <p>Internal use only. Enter password to continue.</p>
    <input type="password" id="pw-input" placeholder="Password" autocomplete="current-password">
    <button class="btn-login" onclick="checkPassword()">Enter</button>
    <div class="login-error" id="login-error">Incorrect password.</div>
  </div>
</div>

<!-- ‚îÄ‚îÄ App ‚îÄ‚îÄ -->
<div id="app">

  <!-- Header -->
  <div class="tool-header">
    <div style="display:flex;align-items:center;gap:.6rem">
      <div class="tool-logo">Improve<span>YourSite</span></div>
      <span class="tool-badge">Audit Tool</span>
    </div>
    <div style="display:flex;gap:.5rem;align-items:center">
      <button class="btn-implement" id="implement-btn" onclick="openImplement()">‚ö° Implement Changes ‚Üí</button>
      <button class="btn-pres" id="pres-btn" onclick="togglePresMode()">üì∫ Presentation Mode</button>
      <button class="btn-logout" onclick="logout()">Log out</button>
    </div>
  </div>

  <!-- Audit form -->
  <div class="audit-form-section">
    <div class="audit-form">
      <input class="audit-input" id="url-input" type="url" placeholder="https://competitorsite.com.au" autocomplete="off">
      <input class="audit-input" id="area-input" type="text" placeholder="Area e.g. Bathurst NSW" autocomplete="off">
      <input class="audit-input" id="biz-input" type="text" placeholder="Business type e.g. Plumber" autocomplete="off">
      <button class="btn-audit" id="run-btn" onclick="runAudit()">Run Audit ‚Üí</button>
    </div>
    <p class="api-hint">
      Runs Google Lighthouse via PageSpeed Insights API (free, no key needed for occasional use).
      For high-volume use, add a free key at
      <a href="https://console.cloud.google.com" target="_blank">console.cloud.google.com</a>
      and set <code>API_KEY</code> below.
    </p>
  </div>

  <!-- Error -->
  <div class="error-banner" id="error-banner"></div>

  <!-- Loading -->
  <div id="loading">
    <div class="spinner"></div>
    <p class="loading-status" id="loading-status">Running Lighthouse audit (mobile)‚Ä¶</p>
    <p class="loading-url" id="loading-url"></p>
    <p style="font-size:.8rem;color:#94a3b8;margin-top:.5rem;">Usually takes 20‚Äì40 seconds</p>
  </div>

  <!-- Results -->
  <div id="results">

    <!-- Meta bar -->
    <div class="result-meta">
      <div><strong>URL:</strong> <a id="r-url" href="#" target="_blank"></a></div>
      <div><strong>Area:</strong> <span id="r-area">‚Äî</span></div>
      <div><strong>Type:</strong> <span id="r-biz">‚Äî</span></div>
      <span id="sb-badge" class="sb-badge" style="display:none"></span>
      <div style="margin-left:auto;color:#94a3b8" id="r-date"></div>
    </div>

    <!-- Score cards -->
    <div class="scores-grid" id="scores-grid">
      <div class="score-card" id="sc-perf">
        <div class="score-label">Performance</div>
        <div class="score-num">‚Äî</div>
        <div class="score-target">IYS target: 90+</div>
        <div class="score-delta"></div>
      </div>
      <div class="score-card" id="sc-seo">
        <div class="score-label">SEO</div>
        <div class="score-num">‚Äî</div>
        <div class="score-target">IYS target: 90+</div>
        <div class="score-delta"></div>
      </div>
      <div class="score-card" id="sc-a11y">
        <div class="score-label">Accessibility</div>
        <div class="score-num">‚Äî</div>
        <div class="score-target">IYS target: 90+</div>
        <div class="score-delta"></div>
      </div>
      <div class="score-card" id="sc-bp">
        <div class="score-label">Best Practices</div>
        <div class="score-num">‚Äî</div>
        <div class="score-target">IYS target: 90+</div>
        <div class="score-delta"></div>
      </div>
    </div>

    <!-- Core Web Vitals -->
    <div class="panel">
      <div class="panel-title">Core Web Vitals (Mobile)</div>
      <div class="vitals-grid" id="vitals-grid"></div>
    </div>

    <!-- Real User Data (CrUX) -->
    <div class="panel" id="crux-panel" style="display:none">
      <div class="panel-title">Real User Data ‚Äî Field Performance (Chrome Users, Mobile)</div>
      <div id="crux-note"></div>
      <div class="vitals-grid" id="crux-grid"></div>
      <p class="crux-source">Source: Chrome UX Report (p75 ‚Äî actual Chrome users on mobile, last 28 days)</p>
    </div>

    <!-- Site Intelligence -->
    <div class="panel" id="intel-panel" style="display:none">
      <div class="panel-title">Site Intelligence</div>
      <div id="intel-content"></div>
    </div>

    <!-- Issues -->
    <div class="panel">
      <div class="panel-title">SEO & Technical Issues</div>
      <div class="issues-list" id="issues-list"></div>
    </div>

    <!-- Plain-English Summary -->
    <div class="panel" id="summary-panel" style="display:none">
      <div class="panel-title">What This Means ‚Äî Plain English</div>
      <p id="summary-para" style="font-size:.95rem;line-height:1.75;color:#374151"></p>
    </div>

    <!-- What We'd Fix -->
    <div class="panel" id="improvements-panel" style="display:none">
      <div class="panel-title">What We'd Fix ‚Äî Specific to This Site</div>
      <div style="overflow-x:auto">
        <table class="improvements-table" id="improvements-table">
          <thead>
            <tr>
              <th>Current Issue</th>
              <th>What IYS Does</th>
              <th>What You Gain</th>
              <th>Priority</th>
            </tr>
          </thead>
          <tbody id="improvements-body"></tbody>
        </table>
      </div>
    </div>

    <!-- Proposed Solution -->
    <div id="proposal-section" style="display:none">
      <div class="proposal-card" id="proposal-card"></div>
    </div>

    <!-- Revenue impact -->
    <div class="panel panel-internal">
      <div class="panel-title">Revenue Impact Estimate</div>
      <div class="revenue-grid">
        <div class="revenue-input-group">
          <label>Est. monthly visitors</label>
          <input class="revenue-input" id="rev-visitors" type="number" value="800">
          <label style="margin-top:.5rem">Current conversion rate (%)</label>
          <input class="revenue-input" id="rev-current" type="number" value="1.2" step="0.1">
          <label style="margin-top:.5rem">Average customer value (AUD)</label>
          <input class="revenue-input" id="rev-value" type="number" value="850">
          <button class="btn-calc" onclick="calcRevenue()">Calculate ‚Üí</button>
        </div>
        <div class="revenue-result">
          <div class="revenue-label">Estimated annual revenue being left on the table</div>
          <div class="revenue-number" id="rev-number">$0</div>
          <div class="revenue-period" id="rev-annual"></div>
          <div style="margin-top:.75rem;font-size:.78rem;color:#94a3b8" id="rev-note">Enter visitors and click Calculate</div>
        </div>
      </div>
    </div>

    <!-- Talking points -->
    <div class="panel panel-internal">
      <div class="panel-title">Call Talking Points (internal)</div>
      <div class="talking-points" id="talking-points"></div>
      <div class="strategy-note" id="strategy-note" style="display:none"></div>
    </div>

    <!-- Notes + Package -->
    <div class="panel panel-internal">
      <div class="panel-title">Call Notes & Recommendation (internal)</div>
      <div class="notes-grid">
        <div>
          <p style="font-size:.82rem;font-weight:600;color:#374151;margin-bottom:.4rem">Your pre-call notes</p>
          <textarea id="call-notes" placeholder="Competitor names, Google rankings you found, things to mention on the call‚Ä¶"></textarea>
        </div>
        <div class="pkg-select-wrap">
          <label>Recommended package</label>
          <select class="pkg-select" id="pkg-rec">
            <option value="">‚Äî Choose after audit ‚Äî</option>
            <option value="scanfix">Scan & Fix ‚Äî $3,000</option>
            <option value="build">Complete Build ‚Äî $5,000</option>
            <option value="premium">Premium Growth ‚Äî $10,000</option>
          </select>
          <label style="margin-top:.25rem">Confidence level</label>
          <select class="pkg-select" id="confidence">
            <option value="">‚Äî</option>
            <option value="high">High ‚Äî will close on call</option>
            <option value="med">Medium ‚Äî needs follow-up</option>
            <option value="low">Low ‚Äî just gathering info</option>
          </select>
          <label style="margin-top:.25rem">Prospect email</label>
          <input class="audit-input" id="prospect-email" type="email" placeholder="client@example.com.au">
        </div>
      </div>
    </div>

    <!-- Actions -->
    <div class="action-bar">
      <button class="btn-action btn-save" onclick="saveAudit()">Save to History</button>
      <button class="btn-action btn-copy" onclick="copyTalkingPoints()">Copy Talking Points</button>
      <button class="btn-action btn-print" onclick="window.print()">Print Report</button>
      <span class="save-confirm" id="save-confirm">‚úì Saved</span>
    </div>

  </div><!-- /#results -->

  <!-- History -->
  <div id="history-section" style="display:none">
    <div class="history-title">Recent Audits</div>
    <div class="history-list" id="history-list"></div>
  </div>

</div><!-- /#app -->

<script>
  // ‚îÄ‚îÄ Config ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const API_KEY  = 'AIzaSyCCvJYpENWHwZcCGfCfCLxJDn07NXPXwUs';
  const PSI_BASE = 'https://www.googleapis.com/pagespeedonline/v5/runPagespeed';
  const CRUX_BASE = 'https://chromeuxreport.googleapis.com/v1/records:queryRecord';
  const SB_BASE   = 'https://safebrowsing.googleapis.com/v4/threatMatches:find';

  // ‚îÄ‚îÄ Auth ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function sha256(s) {
    const b = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(s));
    return Array.from(new Uint8Array(b)).map(x => x.toString(16).padStart(2,'0')).join('');
  }
  async function checkPassword() {
    const v = document.getElementById('pw-input').value;
    const [a, b] = await Promise.all([sha256(v), sha256('improveyoursite2025')]);
    if (a === b) {
      sessionStorage.setItem('iy_audit', '1');
      document.getElementById('login-screen').style.display = 'none';
      document.getElementById('app').style.display = 'block';
      renderHistory();
    } else {
      document.getElementById('login-error').style.display = 'block';
    }
  }
  function logout() {
    sessionStorage.removeItem('iy_audit');
    location.reload();
  }
  if (sessionStorage.getItem('iy_audit') === '1') {
    document.getElementById('login-screen').style.display = 'none';
    document.getElementById('app').style.display = 'block';
    setTimeout(renderHistory, 100);
  }
  document.getElementById('pw-input').addEventListener('keydown', e => {
    if (e.key === 'Enter') checkPassword();
  });

  // ‚îÄ‚îÄ Colour helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function scoreColor(s) {
    return s >= 90 ? '#16a34a' : s >= 50 ? '#d97706' : '#dc2626';
  }
  function scoreClass(s) {
    return s >= 90 ? 'pass' : s >= 50 ? 'warn' : 'fail';
  }
  function vitalColor(key, val) {
    const thresholds = {
      lcp:  { good: 2500, poor: 4000 },
      fcp:  { good: 1800, poor: 3000 },
      tbt:  { good: 200,  poor: 600  },
      cls:  { good: 0.1,  poor: 0.25 },
      si:   { good: 3400, poor: 5800 },
      tti:  { good: 3800, poor: 7300 },
    };
    const t = thresholds[key];
    if (!t) return '#64748b';
    return val <= t.good ? '#16a34a' : val <= t.poor ? '#d97706' : '#dc2626';
  }
  function vitalLabel(key, val) {
    const thresholds = {
      lcp:  { good: 2500, poor: 4000 },
      fcp:  { good: 1800, poor: 3000 },
      tbt:  { good: 200,  poor: 600  },
      cls:  { good: 0.1,  poor: 0.25 },
      si:   { good: 3400, poor: 5800 },
      tti:  { good: 3800, poor: 7300 },
    };
    const t = thresholds[key];
    if (!t) return '';
    return val <= t.good ? '‚úì Good' : val <= t.poor ? '‚ö† Needs work' : '‚úó Poor';
  }
  function vitalLabelClass(key, val) {
    const thresholds = {
      lcp:  { good: 2500, poor: 4000 },
      fcp:  { good: 1800, poor: 3000 },
      tbt:  { good: 200,  poor: 600  },
      cls:  { good: 0.1,  poor: 0.25 },
      si:   { good: 3400, poor: 5800 },
      tti:  { good: 3800, poor: 7300 },
    };
    const t = thresholds[key];
    if (!t) return '';
    return val <= t.good ? 'pass' : val <= t.poor ? 'warn' : 'fail';
  }

  // ‚îÄ‚îÄ Audit runner ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  let lastAudit = null;
  let _lastPageData = null;

  async function runAudit() {
    const rawUrl = document.getElementById('url-input').value.trim();
    const area   = document.getElementById('area-input').value.trim();
    const biz    = document.getElementById('biz-input').value.trim();

    if (!rawUrl) { alert('Enter a URL to audit.'); return; }
    const url = rawUrl.startsWith('http') ? rawUrl : 'https://' + rawUrl;

    // Reset UI
    document.getElementById('results').style.display = 'none';
    document.getElementById('error-banner').style.display = 'none';
    document.getElementById('loading').style.display = 'block';
    document.getElementById('loading-url').textContent = url;
    document.getElementById('loading-status').textContent = 'Running Lighthouse audit (mobile)‚Ä¶';
    document.getElementById('run-btn').disabled = true;
    document.getElementById('save-confirm').style.display = 'none';

    try {
      document.getElementById('loading-status').textContent = 'Running 4 checks in parallel‚Ä¶';
      const [psiR, cruxR, sbR, contentR] = await Promise.allSettled([
        fetchPageSpeed(url),
        fetchCrux(url),
        checkSafeBrowsing(url),
        fetchPageContent(url),
      ]);
      if (psiR.status === 'rejected') throw psiR.reason;
      renderResults(
        psiR.value,
        cruxR.status   === 'fulfilled' ? cruxR.value   : null,
        sbR.status     === 'fulfilled' ? sbR.value     : null,
        contentR.status === 'fulfilled' ? contentR.value : null,
        url, area, biz
      );
    } catch (err) {
      document.getElementById('loading').style.display = 'none';
      const eb = document.getElementById('error-banner');
      eb.style.display = 'block';
      eb.innerHTML = `<strong>Audit failed.</strong> ${err.message || 'Check the URL is publicly accessible and try again.'}`;
    } finally {
      document.getElementById('run-btn').disabled = false;
    }
  }

  async function fetchPageSpeed(url) {
    const cats = 'category=performance&category=seo&category=accessibility&category=best-practices';
    const key  = API_KEY ? `&key=${API_KEY}` : '';
    const apiUrl = `${PSI_BASE}?url=${encodeURIComponent(url)}&strategy=mobile&${cats}${key}`;
    const res = await fetch(apiUrl);
    if (!res.ok) {
      const json = await res.json().catch(() => ({}));
      const msg = json?.error?.message || `API error ${res.status}`;
      throw new Error(msg);
    }
    return res.json();
  }

  // ‚îÄ‚îÄ CrUX ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function fetchCrux(url) {
    const res = await fetch(`${CRUX_BASE}?key=${API_KEY}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ url, formFactor: 'PHONE' }),
      signal: AbortSignal.timeout(15000),
    });
    if (res.status === 404) return null; // not enough real-user data
    if (!res.ok) return null;
    return res.json();
  }

  // ‚îÄ‚îÄ Safe Browsing ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function checkSafeBrowsing(url) {
    const res = await fetch(`${SB_BASE}?key=${API_KEY}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        client: { clientId: 'iy-audit', clientVersion: '1.0' },
        threatInfo: {
          threatTypes: ['MALWARE','SOCIAL_ENGINEERING','UNWANTED_SOFTWARE','POTENTIALLY_HARMFUL_APPLICATION'],
          platformTypes: ['ANY_PLATFORM'],
          threatEntryTypes: ['URL'],
          threatEntries: [{ url }],
        },
      }),
      signal: AbortSignal.timeout(8000),
    });
    if (!res.ok) return null;
    const data = await res.json();
    return (data.matches?.length > 0) ? 'flagged' : 'clean';
  }

  // ‚îÄ‚îÄ Page content scraper ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function fetchPageContent(url) {
    const res = await fetch(
      `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`,
      { signal: AbortSignal.timeout(10000) }
    );
    if (!res.ok) return null;
    const data = await res.json();
    return data.contents || null;
  }

  const PLATFORMS = [
    { name: 'Wix', re: /wix\.com|wixstatic\.com/i, warn: true,
      note: 'Wix has a hard performance ceiling around 65/100. The platform itself is the bottleneck ‚Äî a rebuild on clean code is the only way past it.' },
    { name: 'Squarespace', re: /squarespace\.com|sqsp\.net/i, warn: true,
      note: 'Squarespace typically scores 40‚Äì65/100. Template-based with limited optimisation control.' },
    { name: 'Shopify', re: /cdn\.shopify\.com|shopify\.com\/s/i, warn: false,
      note: 'Shopify is reasonable for ecommerce but often carries performance bloat from apps and themes.' },
    { name: 'Webflow', re: /webflow\.com|\.webflow\.io/i, warn: false,
      note: 'Webflow generally performs better than Wix/Squarespace but is still template-limited.' },
    { name: 'GoDaddy', re: /godaddy\.com|websitebuilder\.godaddy/i, warn: true,
      note: 'GoDaddy Website Builder has a low performance ceiling, similar to Wix. A rebuild is the right fix.' },
    { name: 'WordPress', re: /wp-content|wp-includes/i, warn: false,
      note: 'WordPress ‚Äî performance depends on hosting, theme and plugins. Often improvable with a targeted Scan & Fix.' },
    { name: 'Duda', re: /dudaone\.com|irp\.cdn-website\.com/i, warn: false,
      note: 'Duda ‚Äî used by some agencies. Moderate performance ceiling.' },
  ];

  function detectPlatform(html) {
    for (const p of PLATFORMS) {
      if (p.re.test(html)) return p;
    }
    const gen = html.match(/<meta[^>]+name=["']generator["'][^>]+content=["']([^"']+)/i)?.[1];
    if (gen) return { name: gen.split(' ')[0], warn: false, note: 'CMS detected via generator tag.' };
    return null; // custom / unknown
  }

  function extractPageData(html) {
    if (!html) return null;
    const get = re => html.match(re)?.[1]?.trim() || null;
    const title     = get(/<title[^>]*>([^<]+)<\/title>/i);
    const metaDesc  = get(/<meta[^>]+name=["']description["'][^>]+content=["']([^"']{1,250})/i)
                   || get(/<meta[^>]+content=["']([^"']{1,250})["'][^>]+name=["']description["']/i);
    const h1        = get(/<h1[^>]*>([^<]{1,120})/i);
    const hasForm   = /<form[\s>]/i.test(html);
    const hasPhone  = /href=["']tel:/i.test(html);
    const phoneRe   = /\b(0[45]\d{2}[\s.\-]?\d{3}[\s.\-]?\d{3}|0[2-8][\s.\-]?\d{4}[\s.\-]?\d{4}|1[38]00[\s.\-]?\d{3}[\s.\-]?\d{3})\b/g;
    const phones    = [...new Set(html.match(phoneRe) || [])].slice(0, 2);
    const yearMatch = html.match(/(?:¬©|&copy;|copyright)\s*(?:copyright\s+)?(\d{4})/i);
    const copyrightYear = yearMatch ? parseInt(yearMatch[1]) : null;
    const platform  = detectPlatform(html);
    return { title, metaDesc, h1, hasForm, hasPhone, phones, copyrightYear, platform };
  }

  // ‚îÄ‚îÄ Render results ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function renderResults(data, cruxData, sbResult, pageHtml, url, area, biz) {
    document.getElementById('loading').style.display = 'none';
    document.getElementById('results').style.display = 'block';

    const lhr      = data.lighthouseResult;
    const cats     = lhr.categories;
    const audits   = lhr.audits;

    const scores = {
      performance:    Math.round((cats.performance?.score ?? 0) * 100),
      seo:            Math.round((cats.seo?.score ?? 0) * 100),
      accessibility:  Math.round((cats.accessibility?.score ?? 0) * 100),
      bp:             Math.round((cats['best-practices']?.score ?? 0) * 100),
    };

    const vitals = {
      lcp: audits['largest-contentful-paint']?.numericValue ?? null,
      fcp: audits['first-contentful-paint']?.numericValue ?? null,
      tbt: audits['total-blocking-time']?.numericValue ?? null,
      cls: audits['cumulative-layout-shift']?.numericValue ?? null,
      si:  audits['speed-index']?.numericValue ?? null,
      tti: audits['interactive']?.numericValue ?? null,
      lcpDisplay: audits['largest-contentful-paint']?.displayValue ?? '‚Äî',
      fcpDisplay: audits['first-contentful-paint']?.displayValue ?? '‚Äî',
      tbtDisplay: audits['total-blocking-time']?.displayValue ?? '‚Äî',
      clsDisplay: audits['cumulative-layout-shift']?.displayValue ?? '‚Äî',
      siDisplay:  audits['speed-index']?.displayValue ?? '‚Äî',
      ttiDisplay: audits['interactive']?.displayValue ?? '‚Äî',
    };

    const issues = {
      metaDesc:       (audits['meta-description']?.score ?? 0) === 1,
      title:          (audits['document-title']?.score ?? 0) === 1,
      viewport:       (audits['viewport']?.score ?? 0) === 1,
      httpsOk:        (audits['is-on-https']?.score ?? 1) === 1,
      robotsTxt:      (audits['robots-txt']?.score ?? 0) === 1,
      canonical:      (audits['canonical']?.score ?? null) === 1,
      imageAlt:       (audits['image-alt']?.score ?? 0) === 1,
      imageAltCount:  audits['image-alt']?.details?.items?.length ?? 0,
      structuredData: (audits['structured-data']?.score ?? null) === 1,
      renderBlocking: (audits['render-blocking-resources']?.score ?? 1) === 1,
      unusedJS:       (audits['unused-javascript']?.score ?? 1) >= 0.9,
      unusedCSS:      (audits['unused-css-rules']?.score ?? 1) >= 0.9,
      textCompression:(audits['uses-text-compression']?.score ?? 1) === 1,
      responsiveImg:  (audits['uses-responsive-images']?.score ?? 1) === 1,
      linkText:       (audits['link-text']?.score ?? 1) === 1,
    };

    const pageData = extractPageData(pageHtml);
    _lastPageData = pageData;
    lastAudit = { url, area, biz, date: new Date().toLocaleDateString('en-AU'), scores, vitals, issues };

    // Meta bar
    const rUrl = document.getElementById('r-url');
    rUrl.textContent = url; rUrl.href = url;
    document.getElementById('r-area').textContent = area || '‚Äî';
    document.getElementById('r-biz').textContent  = biz  || '‚Äî';
    document.getElementById('r-date').textContent = new Date().toLocaleDateString('en-AU', { day:'numeric', month:'short', year:'numeric' });
    renderSafeBrowsing(sbResult);

    // Score cards
    renderScoreCard('sc-perf', scores.performance, 'Performance');
    renderScoreCard('sc-seo',  scores.seo,         'SEO');
    renderScoreCard('sc-a11y', scores.accessibility,'Accessibility');
    renderScoreCard('sc-bp',   scores.bp,           'Best Practices');

    // Vitals
    const vg = document.getElementById('vitals-grid');
    vg.innerHTML = '';
    const vitalItems = [
      { key: 'lcp', name: 'Largest Contentful Paint', desc: 'Main content load time', val: vitals.lcp, disp: vitals.lcpDisplay },
      { key: 'fcp', name: 'First Contentful Paint',   desc: 'Time to first pixel',    val: vitals.fcp, disp: vitals.fcpDisplay },
      { key: 'tbt', name: 'Total Blocking Time',      desc: 'Interaction delay',       val: vitals.tbt, disp: vitals.tbtDisplay },
      { key: 'cls', name: 'Layout Shift (CLS)',        desc: 'Visual stability',        val: vitals.cls, disp: vitals.clsDisplay },
      { key: 'si',  name: 'Speed Index',               desc: 'Perceived load speed',    val: vitals.si,  disp: vitals.siDisplay  },
      { key: 'tti', name: 'Time to Interactive',       desc: 'Fully usable',            val: vitals.tti, disp: vitals.ttiDisplay },
    ];
    vitalItems.forEach(v => {
      const color = vitalColor(v.key, v.val);
      const label = vitalLabel(v.key, v.val);
      const cls   = vitalLabelClass(v.key, v.val);
      vg.innerHTML += `
        <div class="vital-item">
          <div>
            <div class="vital-name">${v.name}</div>
            <div class="vital-desc">${v.desc}</div>
          </div>
          <div class="vital-right">
            <div class="vital-value" style="--vital-color:${color}">${v.disp}</div>
            <div class="vital-status ${cls}">${label}</div>
          </div>
        </div>`;
    });

    // Issues
    const il = document.getElementById('issues-list');
    il.innerHTML = '';
    const issueItems = [
      { ok: issues.httpsOk,        label: 'HTTPS / SSL',              good: 'Secure connection ‚Äî good.',                    bad: 'No HTTPS ‚Äî a security flag for Google and visitors.' },
      { ok: issues.title,          label: 'Page title tag',           good: 'Title tag present.',                           bad: 'No title tag ‚Äî Google uses this as your search headline.' },
      { ok: issues.metaDesc,       label: 'Meta description',         good: 'Meta description found.',                      bad: 'No meta description ‚Äî Google writes your search snippet itself.' },
      { ok: issues.viewport,       label: 'Mobile viewport',          good: 'Mobile-friendly viewport set.',                bad: 'No mobile viewport ‚Äî site is not configured for phones.' },
      { ok: issues.imageAlt,       label: `Image alt text`,           good: 'All images have alt text.',                    bad: `${issues.imageAltCount || 'Some'} image${issues.imageAltCount !== 1 ? 's' : ''} missing alt text ‚Äî invisible to Google Images.` },
      { ok: issues.structuredData, label: 'Structured data',          good: 'Schema markup found.',                         bad: 'No structured data ‚Äî missing rich result opportunities.' },
      { ok: issues.robotsTxt,      label: 'Robots.txt',               good: 'Robots.txt found.',                            bad: 'No robots.txt ‚Äî Google has no crawl guidance.' },
      { ok: issues.canonical,      label: 'Canonical tag',            good: 'Canonical URL set.',                           bad: 'No canonical tag ‚Äî potential duplicate content issues.' },
      { ok: issues.renderBlocking, label: 'Render-blocking resources',good: 'No render-blocking resources.',                bad: 'Render-blocking CSS/JS is slowing first paint.' },
      { ok: issues.unusedJS,       label: 'Unused JavaScript',        good: 'JavaScript is lean.',                          bad: 'Significant unused JavaScript is slowing load.' },
      { ok: issues.unusedCSS,      label: 'Unused CSS',               good: 'CSS is lean.',                                 bad: 'Unused CSS is adding unnecessary file weight.' },
      { ok: issues.textCompression,label: 'Text compression (gzip)',  good: 'Compression enabled.',                         bad: 'No text compression ‚Äî files are larger than necessary.' },
      { ok: issues.responsiveImg,  label: 'Responsive images',        good: 'Images properly sized.',                       bad: 'Images served too large for mobile ‚Äî wasting bandwidth.' },
      { ok: issues.linkText,       label: 'Descriptive link text',    good: 'Links have descriptive text.',                 bad: 'Some links use generic text ("click here") ‚Äî bad for SEO.' },
    ];
    issueItems.forEach(i => {
      if (i.ok === null) return; // skip if no data
      il.innerHTML += `
        <div class="issue-item ${i.ok ? 'ok' : 'bad'}">
          <div class="issue-icon">${i.ok ? '‚úÖ' : '‚ùå'}</div>
          <div class="issue-text">
            <strong>${i.label}</strong>
            <span>${i.ok ? i.good : i.bad}</span>
          </div>
        </div>`;
    });

    // CrUX + Site Intelligence (new panels)
    renderRealUserData(cruxData);
    renderSiteIntelligence(pageData);

    // Plain-English summary
    renderSummary(scores, vitals, issues, biz, area, pageData);

    // Improvements + Proposal
    renderImprovements(scores, vitals, issues);
    renderProposal(scores, issues, biz);

    // Talking points (pass pageData for platform-specific points)
    renderTalkingPoints(scores, vitals, issues, biz, area, pageData);

    // Auto-set package recommendation
    const pkgRec = document.getElementById('pkg-rec');
    if (scores.performance < 60 || Object.values(issues).filter(v => v === false).length > 5) {
      pkgRec.value = 'build';
    } else if (scores.performance < 85 || !issues.structuredData || !issues.metaDesc) {
      pkgRec.value = 'scanfix';
    }

    // Revenue calc with defaults
    calcRevenue();

    // Scroll to results
    document.getElementById('results').scrollIntoView({ behavior: 'smooth', block: 'start' });
  }

  function renderScoreCard(id, score, label) {
    const card  = document.getElementById(id);
    const color = scoreColor(score);
    card.style.setProperty('--score-color', color);
    const delta = 90 - score;
    card.querySelector('.score-num').textContent   = score;
    card.querySelector('.score-num').style.color   = color;
    const deltaEl = card.querySelector('.score-delta');
    if (delta > 0) {
      deltaEl.textContent = `+${delta} pts to IYS target`;
      deltaEl.style.color = '#94a3b8';
    } else {
      deltaEl.textContent = '‚úì Meets IYS target';
      deltaEl.style.color = '#16a34a';
    }
  }

  // ‚îÄ‚îÄ Safe Browsing badge ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function renderSafeBrowsing(result) {
    const el = document.getElementById('sb-badge');
    if (result === 'clean') {
      el.className = 'sb-badge sb-clean';
      el.textContent = '‚úÖ No security warnings';
      el.style.display = 'inline-flex';
    } else if (result === 'flagged') {
      el.className = 'sb-badge sb-flagged';
      el.textContent = 'üö® Google safety warning';
      el.style.display = 'inline-flex';
    } else {
      el.className = 'sb-badge sb-unknown';
      el.textContent = 'Safety check unavailable';
      el.style.display = 'inline-flex';
    }
  }

  // ‚îÄ‚îÄ Real User Data (CrUX) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function renderRealUserData(cruxData) {
    const panel = document.getElementById('crux-panel');
    const grid  = document.getElementById('crux-grid');
    const note  = document.getElementById('crux-note');

    if (!cruxData) {
      note.className = 'crux-note';
      note.innerHTML = '‚ö† No field data available ‚Äî this site doesn\'t have enough Chrome traffic in the last 28 days for Google to report real-user metrics. The Lighthouse lab scores above are the best available signal.';
      note.style.display = 'block';
      grid.innerHTML = '';
      panel.style.display = 'block';
      return;
    }

    const metrics = cruxData.record?.metrics || {};
    const cruxThresholds = {
      largest_contentful_paint:   { good: 2500,  poor: 4000,  unit: 'ms',  label: 'LCP (Real Users)' },
      first_contentful_paint:     { good: 1800,  poor: 3000,  unit: 'ms',  label: 'FCP (Real Users)' },
      cumulative_layout_shift:    { good: 0.1,   poor: 0.25,  unit: '',    label: 'CLS (Real Users)' },
      interaction_to_next_paint:  { good: 200,   poor: 500,   unit: 'ms',  label: 'INP (Real Users)' },
      experimental_time_to_first_byte: { good: 800, poor: 1800, unit: 'ms', label: 'TTFB (Real Users)' },
    };

    note.style.display = 'none';
    grid.innerHTML = '';

    let hasAny = false;
    for (const [key, t] of Object.entries(cruxThresholds)) {
      const m = metrics[key];
      if (!m) continue;
      hasAny = true;
      const p75 = m.percentiles?.p75 ?? null;
      if (p75 === null) continue;
      const displayVal = t.unit === 'ms' ? (p75 >= 1000 ? (p75/1000).toFixed(1) + ' s' : Math.round(p75) + ' ms') : p75.toFixed(3);
      const color = p75 <= t.good ? '#16a34a' : p75 <= t.poor ? '#d97706' : '#dc2626';
      const status = p75 <= t.good ? '‚úì Good' : p75 <= t.poor ? '‚ö† Needs work' : '‚úó Poor';
      const cls    = p75 <= t.good ? 'pass' : p75 <= t.poor ? 'warn' : 'fail';
      grid.innerHTML += `
        <div class="vital-item">
          <div>
            <div class="vital-name">${t.label}</div>
            <div class="vital-desc">p75 ‚Äî 75th percentile real users</div>
          </div>
          <div class="vital-right">
            <div class="vital-value" style="--vital-color:${color}">${displayVal}</div>
            <div class="vital-status ${cls}">${status}</div>
          </div>
        </div>`;
    }

    if (!hasAny) {
      note.className = 'crux-note';
      note.innerHTML = 'Field data received but no individual metrics were available for this URL.';
      note.style.display = 'block';
    }

    panel.style.display = 'block';
  }

  // ‚îÄ‚îÄ Site Intelligence ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function renderSiteIntelligence(pageData) {
    const panel   = document.getElementById('intel-panel');
    const content = document.getElementById('intel-content');

    if (!pageData) {
      content.innerHTML = '<p style="font-size:.84rem;color:#94a3b8">Could not fetch page content ‚Äî site may block external requests.</p>';
      panel.style.display = 'block';
      return;
    }

    let html = '';

    // Platform
    if (pageData.platform) {
      const p = pageData.platform;
      const badgeColor = p.warn ? '#fee2e2' : '#f0f4ff';
      const badgeText  = p.warn ? '#dc2626' : '#3730a3';
      html += `<div style="margin-bottom:.85rem">`;
      html += `<span class="platform-badge" style="background:${badgeColor};color:${badgeText}">${p.name}</span>`;
      html += `<div class="platform-note ${p.warn ? '' : 'neutral'}">${p.note}</div>`;
      html += `</div>`;
    }

    // Grid of intel items
    html += '<div class="intel-grid">';

    // Title
    html += `<div class="intel-item ${pageData.title ? 'intel-ok' : 'intel-bad'}">
      <div>
        <span class="intel-label">${pageData.title ? '‚úÖ' : '‚ùå'} Page Title</span>
        <span class="intel-value">${pageData.title ? escHtml(pageData.title) : 'Not found'}</span>
      </div>
    </div>`;

    // Meta description
    html += `<div class="intel-item ${pageData.metaDesc ? 'intel-ok' : 'intel-bad'}">
      <div>
        <span class="intel-label">${pageData.metaDesc ? '‚úÖ' : '‚ùå'} Meta Description</span>
        <span class="intel-value">${pageData.metaDesc ? escHtml(pageData.metaDesc.substring(0,120)) + (pageData.metaDesc.length > 120 ? '‚Ä¶' : '') : 'Missing'}</span>
      </div>
    </div>`;

    // H1
    html += `<div class="intel-item ${pageData.h1 ? 'intel-ok' : 'intel-bad'}">
      <div>
        <span class="intel-label">${pageData.h1 ? '‚úÖ' : '‚ùå'} H1 Heading</span>
        <span class="intel-value">${pageData.h1 ? escHtml(pageData.h1) : 'No H1 found'}</span>
      </div>
    </div>`;

    // Contact form
    html += `<div class="intel-item ${pageData.hasForm ? 'intel-ok' : 'intel-bad'}">
      <div>
        <span class="intel-label">${pageData.hasForm ? '‚úÖ' : '‚ùå'} Contact / Lead Form</span>
        <span class="intel-value">${pageData.hasForm ? 'Form detected on page' : 'No form found ‚Äî may be missing leads'}</span>
      </div>
    </div>`;

    // Phone
    const phoneText = pageData.phones?.length ? pageData.phones.join(', ') : (pageData.hasPhone ? 'Found (tel: link)' : 'No phone detected');
    const phoneOk   = pageData.phones?.length > 0 || pageData.hasPhone;
    html += `<div class="intel-item ${phoneOk ? 'intel-ok' : 'intel-bad'}">
      <div>
        <span class="intel-label">${phoneOk ? '‚úÖ' : '‚ùå'} Phone Number</span>
        <span class="intel-value">${escHtml(phoneText)}</span>
      </div>
    </div>`;

    // Copyright year
    const thisYear = new Date().getFullYear();
    const yearOk   = pageData.copyrightYear && pageData.copyrightYear >= thisYear - 1;
    const yearText = pageData.copyrightYear
      ? (pageData.copyrightYear < thisYear - 1 ? `¬© ${pageData.copyrightYear} ‚Äî possibly outdated` : `¬© ${pageData.copyrightYear}`)
      : 'No copyright year found';
    html += `<div class="intel-item ${yearOk ? 'intel-ok' : 'intel-neu'}">
      <div>
        <span class="intel-label">${yearOk ? '‚úÖ' : '‚ö†'} Copyright Year</span>
        <span class="intel-value">${yearText}</span>
      </div>
    </div>`;

    html += '</div>'; // /intel-grid

    content.innerHTML = html;
    panel.style.display = 'block';
  }

  function escHtml(s) {
    return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
  }

  // ‚îÄ‚îÄ Plain-English summary ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function renderSummary(scores, vitals, issues, biz, area, pageData) {
    const panel = document.getElementById('summary-panel');
    const para  = document.getElementById('summary-para');

    const failCount  = Object.values(issues).filter(v => v === false).length;
    const bizLabel   = biz  ? `a ${biz.toLowerCase()} business` : 'this business';
    const areaLabel  = area ? ` in ${area}` : '';
    const platform   = pageData?.platform;

    // Performance sentence
    let perfSentence;
    if (scores.performance >= 90) {
      perfSentence = `The site currently scores ${scores.performance}/100 for mobile performance ‚Äî solid, but there are still areas where a rebuild would push rankings and conversions higher.`;
    } else if (scores.performance >= 60) {
      perfSentence = `The site scores ${scores.performance}/100 for mobile performance. Google's benchmark for a fast, trustworthy site is 90 or above ‚Äî this site is in the "needs improvement" zone, which means slower load times and lower rankings than sites that hit the mark.`;
    } else {
      perfSentence = `The site scores ${scores.performance}/100 for mobile performance ‚Äî Google classifies anything under 50 as "poor". Most mobile visitors are waiting several seconds for the page to load, and research consistently shows that over half of people abandon a site if it takes longer than 3 seconds. That's real enquiries walking away before reading a single word.`;
    }

    // Platform sentence
    let platformSentence = '';
    if (platform?.warn) {
      platformSentence = ` It's built on ${platform.name}, which has a hard performance ceiling built into the platform itself ‚Äî no amount of tweaking the current site will break through it. A rebuild on clean, optimised code is the only real fix.`;
    } else if (platform) {
      platformSentence = ` It's built on ${platform.name}.`;
    }

    // Issues sentence
    let issueSentence;
    if (failCount === 0) {
      issueSentence = ' All technical checks passed ‚Äî the site is well configured from a technical SEO perspective.';
    } else if (failCount <= 3) {
      issueSentence = ` ${failCount} technical issue${failCount > 1 ? 's were' : ' was'} found ‚Äî fixable without a full rebuild in most cases.`;
    } else {
      const keyIssues = [];
      if (!issues.metaDesc)       keyIssues.push('no meta description');
      if (!issues.structuredData) keyIssues.push('no structured data');
      if (!issues.robotsTxt)      keyIssues.push('no sitemap or robots.txt');
      if (!issues.httpsOk)        keyIssues.push('no HTTPS');
      if (!issues.renderBlocking) keyIssues.push('render-blocking resources');
      const issueList = keyIssues.length ? ` ‚Äî including ${keyIssues.slice(0,3).join(', ')}` : '';
      issueSentence = ` ${failCount} out of 14 technical checks failed${issueList}. These aren't cosmetic ‚Äî they directly affect how Google ranks the site and how many visitors turn into enquiries.`;
    }

    // SEO sentence
    let seoSentence = '';
    if (scores.seo < 75) {
      seoSentence = ` The SEO score of ${scores.seo}/100 means Google is having difficulty properly reading and ranking this site ‚Äî several fundamental signals are missing that competitors with well-built sites already have in place.`;
    } else if (scores.seo < 90) {
      seoSentence = ` The SEO score is ${scores.seo}/100 ‚Äî workable, but short of the 90+ that gives a site its best chance of ranking for competitive searches${areaLabel ? ' in ' + area : ''}.`;
    }

    // Closing sentence
    const closeSentence = ` For ${bizLabel}${areaLabel}, a site running at this level is likely converting less than it should ‚Äî and every month it stays this way is another month of enquiries going to a competitor whose site loads faster and ranks higher.`;

    para.textContent = perfSentence + platformSentence + issueSentence + seoSentence + closeSentence;
    panel.style.display = 'block';
  }

  // ‚îÄ‚îÄ Revenue calculator ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function calcRevenue() {
    const visitors = +document.getElementById('rev-visitors').value || 0;
    const current  = (+document.getElementById('rev-current').value || 1.2) / 100;
    const value    = +document.getElementById('rev-value').value || 850;
    // Target rate: improvement based on performance score
    const perfScore = lastAudit?.scores?.performance ?? 50;
    const targetRate = perfScore < 50 ? 0.03 : perfScore < 80 ? 0.025 : 0.022;
    const monthly = Math.round((targetRate - current) * visitors * value);
    const numEl  = document.getElementById('rev-number');
    const annEl  = document.getElementById('rev-annual');
    const noteEl = document.getElementById('rev-note');
    if (monthly > 0) {
      numEl.textContent  = `$${(monthly * 12).toLocaleString('en-AU')}`;
      annEl.textContent  = `per year ¬∑ $${monthly.toLocaleString('en-AU')} per month`;
      noteEl.textContent = `Based on improving conversion from ${(current * 100).toFixed(1)}% ‚Üí ${(targetRate * 100).toFixed(1)}% (realistic post-rebuild target).`;
    } else {
      numEl.textContent  = '$0';
      annEl.textContent  = '';
      noteEl.textContent = 'Adjust inputs and recalculate.';
    }
  }

  // ‚îÄ‚îÄ Presentation mode ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  let presMode = false;
  function togglePresMode() {
    presMode = !presMode;
    document.body.classList.toggle('pres-mode', presMode);
    document.getElementById('pres-btn').textContent = presMode ? '‚úï Exit Presentation' : 'üì∫ Presentation Mode';
  }

  // ‚îÄ‚îÄ Improvements table ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function renderImprovements(scores, vitals, issues) {
    const rows = [];

    if (scores.performance < 90) {
      rows.push({
        issue: `Performance score ${scores.performance}/100`,
        fix: 'Rebuilt on clean, optimised code ‚Äî no bloat, no legacy scripts',
        outcome: '90+ Lighthouse on mobile ‚Äî Google\'s top performance tier',
        level: scores.performance < 50 ? 'critical' : 'high',
      });
    }
    if (vitals.lcp && vitals.lcp > 2500) {
      rows.push({
        issue: `Main content loads in ${vitals.lcpDisplay} (LCP)`,
        fix: 'Image compression, lazy loading, server-side caching',
        outcome: 'LCP under 2.5 seconds ‚Äî passes Google\'s Core Web Vitals',
        level: vitals.lcp > 4000 ? 'critical' : 'high',
      });
    }
    if (vitals.tbt && vitals.tbt > 200) {
      rows.push({
        issue: `Page freezes for ${vitals.tbtDisplay} (TBT) on load`,
        fix: 'JavaScript deferred, split, and minimised',
        outcome: 'Site responds instantly ‚Äî no freezing while loading',
        level: vitals.tbt > 600 ? 'critical' : 'high',
      });
    }
    if (!issues.metaDesc) {
      rows.push({
        issue: 'No meta description ‚Äî Google writes the search snippet',
        fix: 'Professional SEO copywriting for every page',
        outcome: 'You control what potential customers see before clicking',
        level: 'high',
      });
    }
    if (!issues.structuredData) {
      rows.push({
        issue: 'No structured data (Schema markup)',
        fix: 'Business Schema ‚Äî name, address, phone, services, reviews',
        outcome: 'Rich result eligibility: star ratings & hours in Google Search',
        level: 'high',
      });
    }
    if (!issues.imageAlt) {
      rows.push({
        issue: `${issues.imageAltCount || 'Multiple'} images with no alt text`,
        fix: 'Full image audit ‚Äî every image described for Google',
        outcome: 'Google Images visibility + improved accessibility ranking',
        level: 'medium',
      });
    }
    if (!issues.renderBlocking) {
      rows.push({
        issue: 'Render-blocking CSS/JS ‚Äî page delays before anything shows',
        fix: 'Asset loading restructured ‚Äî critical CSS inline, JS deferred',
        outcome: 'Visitors see content immediately ‚Äî fewer early drop-offs',
        level: 'high',
      });
    }
    if (!issues.textCompression) {
      rows.push({
        issue: 'No text compression ‚Äî files served at full size',
        fix: 'Gzip/Brotli compression enabled at delivery level',
        outcome: 'Smaller files ‚Äî faster on all connections including 4G mobile',
        level: 'medium',
      });
    }
    if (!issues.robotsTxt) {
      rows.push({
        issue: 'No robots.txt or XML sitemap',
        fix: 'robots.txt + sitemap generated and submitted to Search Console',
        outcome: 'Google crawls and indexes every page correctly from day one',
        level: 'medium',
      });
    }
    if (!issues.httpsOk) {
      rows.push({
        issue: 'Site not on HTTPS ‚Äî Chrome shows "Not Secure"',
        fix: 'SSL certificate setup and full HTTPS migration',
        outcome: 'Trust restored ‚Äî no security warning before visitors read a word',
        level: 'critical',
      });
    }
    if (!issues.responsiveImg) {
      rows.push({
        issue: 'Images oversized for mobile ‚Äî wasting bandwidth',
        fix: 'Responsive image srcsets ‚Äî right size for every device',
        outcome: 'Faster mobile load without sacrificing image quality',
        level: 'medium',
      });
    }
    if (scores.seo < 90) {
      rows.push({
        issue: `Overall SEO score ${scores.seo}/100`,
        fix: 'Full technical SEO setup: headings, canonical, Open Graph, GSC',
        outcome: 'Google understands and trusts the site ‚Äî rankings improve',
        level: scores.seo < 70 ? 'critical' : 'high',
      });
    }

    const panel = document.getElementById('improvements-panel');
    const tbody = document.getElementById('improvements-body');

    if (!rows.length) {
      panel.style.display = 'none';
      return;
    }

    panel.style.display = 'block';
    const levelLabel = { critical: 'Critical', high: 'High', medium: 'Medium' };
    tbody.innerHTML = rows.map(r => `
      <tr>
        <td class="imp-issue">${r.issue}</td>
        <td class="imp-fix">${r.fix}</td>
        <td class="imp-outcome">${r.outcome}</td>
        <td><span class="imp-priority imp-${r.level}">${levelLabel[r.level]}</span></td>
      </tr>`).join('');
  }

  // ‚îÄ‚îÄ Proposal card ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function renderProposal(scores, issues, biz) {
    const section = document.getElementById('proposal-section');
    const card    = document.getElementById('proposal-card');

    const failCount = Object.values(issues).filter(v => v === false).length;
    let pkgName, pkgPrice, pkgIncludes;

    if (scores.performance < 60 || failCount >= 5) {
      pkgName  = 'Complete Build';
      pkgPrice = '$5,000';
      pkgIncludes = [
        'Custom mobile-first design', 'Full SEO setup + Search Console',
        '90%+ Lighthouse target', 'Booking + lead automation',
        'Analytics + conversion tracking', '3 months support included',
        'You own it ‚Äî no monthly fees', 'Live in 2‚Äì4 weeks',
      ];
    } else {
      pkgName  = 'Scan & Fix';
      pkgPrice = '$3,000';
      pkgIncludes = [
        'Full site audit + issue report', 'Speed + conversion fixes',
        'SEO and UX improvements', 'Lead form + CTA optimisation',
        'Before/after Lighthouse report', 'Quick turnaround',
      ];
    }

    // Build before/after rows
    const baRows = [
      { before: `Performance: ${scores.performance}`, after: 'Performance: 90+' },
      { before: `SEO: ${scores.seo}`, after: 'SEO: 90+' },
    ];
    if (!issues.metaDesc)       baRows.push({ before: '‚ùå No meta description',  after: '‚úÖ SEO copy on every page' });
    if (!issues.structuredData) baRows.push({ before: '‚ùå No structured data',   after: '‚úÖ Full Schema markup' });
    if (!issues.robotsTxt)      baRows.push({ before: '‚ùå No sitemap / robots',  after: '‚úÖ Submitted to Google Search Console' });
    if (!issues.imageAlt)       baRows.push({ before: `‚ùå ${issues.imageAltCount} images untagged`, after: '‚úÖ Full image SEO' });
    if (!issues.httpsOk)        baRows.push({ before: '‚ùå No HTTPS', after: '‚úÖ Secure SSL connection' });
    if (!issues.renderBlocking) baRows.push({ before: '‚ùå Render-blocking assets', after: '‚úÖ Optimised asset delivery' });

    section.style.display = 'block';
    card.innerHTML = `
      <div class="proposal-header">
        <div>
          <div class="proposal-eyebrow">ImproveYourSite ‚Äî Recommended Solution</div>
          <div class="proposal-pkg-name">${pkgName} &nbsp;<span style="color:#2dd4bf">${pkgPrice}</span></div>
        </div>
        <div class="proposal-timeline">‚ö° Live in 2‚Äì4 weeks</div>
      </div>
      <div class="proposal-ba">
        <div>
          <div class="ba-col-label before">Current site${biz ? ' ‚Äî ' + biz : ''}</div>
          ${baRows.map(r => `<div class="ba-row" style="color:rgba(255,255,255,.65)">${r.before}</div>`).join('')}
        </div>
        <div class="ba-arrow-col">‚Üí</div>
        <div>
          <div class="ba-col-label after">After ImproveYourSite</div>
          ${baRows.map(r => `<div class="ba-row" style="color:#2dd4bf;font-weight:600">${r.after}</div>`).join('')}
        </div>
      </div>
      <div class="proposal-includes">
        ${pkgIncludes.map(i => `<div class="prop-inc"><span>‚úì</span>${i}</div>`).join('')}
      </div>`;
  }

  // ‚îÄ‚îÄ Talking points ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function renderTalkingPoints(scores, vitals, issues, biz, area, pageData) {
    const tp   = document.getElementById('talking-points');
    const sn   = document.getElementById('strategy-note');
    const pts  = [];

    // ‚îÄ‚îÄ Platform talking point (goes first if detected) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const platform = pageData?.platform;
    if (platform) {
      const PLATFORM_SCRIPTS = {
        'Wix': {
          level: 'critical',
          why: `Their site is on Wix. Wix has a hard performance ceiling ‚Äî independent testing consistently puts Wix sites between 40 and 65/100 on mobile, regardless of how well the site is designed. This isn't a content problem, it's a platform problem. Google uses Core Web Vitals as a direct ranking signal, and no Wix site can reliably hit the 90+ threshold that clean-coded sites achieve.`,
          cost: `They're also paying Wix a monthly subscription (typically $25‚Äì$50/month, ~$300‚Äì$600/year) to be on a platform that's actively limiting their Google rankings. That money is going to a platform they don't own and can't export.`,
          options: `What to offer on the call:\n  ‚Üí Complete Build ($5,000) ‚Äî the right solution. Clean custom code, 90+ Lighthouse target, they own it outright, zero monthly platform fees. We can typically have it live in 2‚Äì4 weeks.\n  ‚Üí If budget is the objection: frame it as "$5,000 once vs $600/year forever on a platform that's costing them ranking position". Most clients pay the site back inside a year from new enquiries.\n  ‚Üí Do NOT offer Scan & Fix for a Wix site ‚Äî there's a ceiling we literally cannot break through without a rebuild.`,
        },
        'GoDaddy': {
          level: 'critical',
          why: `Their site is on GoDaddy Website Builder ‚Äî one of the worst-performing platforms for Google rankings. GoDaddy Builder sites typically score 30‚Äì60/100 on mobile Lighthouse. The platform generates bloated, template-locked code that no amount of tweaking will fix. Google has been explicitly using Core Web Vitals as a ranking factor since 2021, and GoDaddy sites are structurally at a disadvantage.`,
          cost: `They're paying GoDaddy monthly fees for a platform that's costing them ranking position. GoDaddy's upsell model often has businesses paying $50‚Äì$100+/month across hosting, domain, and add-ons ‚Äî for a product that's hurting their Google presence.`,
          options: `What to offer on the call:\n  ‚Üí Complete Build ($5,000) ‚Äî only real fix. Custom code, 90+ Lighthouse target, full SEO setup, they own the site permanently. No GoDaddy fees, no lock-in.\n  ‚Üí Angle: "We build it once, you own it forever. No monthly platform bill, and you'll actually rank." This lands well with GoDaddy customers who are already frustrated with their costs.\n  ‚Üí Do NOT recommend Scan & Fix ‚Äî the problem is the platform, not the content.`,
        },
        'Squarespace': {
          level: 'high',
          why: `Their site is on Squarespace. Squarespace typically scores 45‚Äì70/100 on mobile ‚Äî better than Wix but still well below the 90+ threshold Google rewards. The platform generates template-locked HTML with heavy JavaScript payloads that slow down every page regardless of content. Squarespace also limits control over technical SEO elements like structured data and canonical tags.`,
          cost: `Squarespace plans typically run $25‚Äì$50/month ($300‚Äì$600/year). Like Wix, they're paying for a platform they don't own, can't fully customise, and that's holding their performance score below the competitive threshold.`,
          options: `What to offer on the call:\n  ‚Üí Complete Build ($5,000) ‚Äî clean code, 90+ Lighthouse, full technical SEO, they own it outright. Two to four weeks to live.\n  ‚Üí Scan & Fix ($3,000) is worth discussing if the client is resistant to a full rebuild ‚Äî it won't fully resolve the platform ceiling but can improve their score and fix every SEO issue within what Squarespace allows. Be honest: they'll likely hit a wall around 70‚Äì75/100.\n  ‚Üí Key close: "Squarespace will always be capped. A clean build removes that ceiling permanently."`,
        },
        'WordPress': {
          level: 'medium',
          why: `Their site is on WordPress. WordPress itself is fine ‚Äî the problem is usually the theme, plugins, or hosting. Heavy page builders (Elementor, Divi, WPBakery) and poor hosting are the most common causes of low WordPress scores. This is often fixable without a full rebuild, depending on how bloated the current setup is.`,
          cost: `WordPress hosting varies widely ‚Äî cheap shared hosting is often the performance bottleneck. If they're on a $10/month shared host, that alone can cut 15‚Äì20 points off their Lighthouse score.`,
          options: `What to offer on the call:\n  ‚Üí Scan & Fix ($3,000) ‚Äî often the right starting point for WordPress sites. We audit the theme, remove plugin bloat, implement caching, optimise images, and fix technical SEO. Most WP sites can reach 85‚Äì95/100 with targeted work.\n  ‚Üí Complete Build ($5,000) ‚Äî worth recommending if the theme is a heavy page builder or the site structure needs a rethink. Cleaner foundation, better long-term result.\n  ‚Üí Ask on the call: "Who built the site and what theme is it on?" ‚Äî this helps qualify which package fits.`,
        },
        'Webflow': {
          level: 'medium',
          why: `Their site is on Webflow. Webflow generally performs better than Wix or Squarespace ‚Äî scores of 60‚Äì80/100 are typical. However, it still generates template-based code with Webflow's own JavaScript overhead, which creates a ceiling below what custom-coded sites can achieve.`,
          cost: `Webflow plans run $23‚Äì$39+/month for business sites (~$300‚Äì$500/year). Clients are paying for a platform they don't fully own and can't host independently.`,
          options: `What to offer on the call:\n  ‚Üí Scan & Fix ($3,000) if the score is above 65 ‚Äî targeted improvements may push them past 80.\n  ‚Üí Complete Build ($5,000) if they're below 65 or want to reach 90+. The only way to fully break the Webflow ceiling.\n  ‚Üí Frame: "Webflow is a step up from Wix, but it still has a ceiling. If you want to compete at the top of Google, clean custom code is the answer."`,
        },
        'Duda': {
          level: 'medium',
          why: `Their site is on Duda ‚Äî a platform used by some agencies for quick builds. Duda sites typically score 50‚Äì75/100 on mobile. Like most hosted website builders, it generates template-locked code with limited ability to optimise performance beyond a point.`,
          cost: `Duda is usually agency-managed, meaning the client is often paying ongoing retainer fees to an agency that built them a templated site on a capped platform.`,
          options: `What to offer on the call:\n  ‚Üí Complete Build ($5,000) ‚Äî clean code, 90+ Lighthouse, full ownership, no ongoing platform fees.\n  ‚Üí Scan & Fix ($3,000) if the score is above 65 ‚Äî improvements within the platform's limits are possible.\n  ‚Üí Ask: "Who manages your current site and what are you paying monthly?" ‚Äî good discovery question.`,
        },
      };

      const script = PLATFORM_SCRIPTS[platform.name];
      if (script) {
        pts.push({
          level: script.level,
          cat: `Platform ‚Äî ${platform.name} Detected`,
          text: `${script.why}\n\n${script.cost}`,
        });
        pts.push({
          level: 'medium',
          cat: `Options to Present ‚Äî ${platform.name}`,
          text: script.options,
        });
      }
    }

    // Performance
    if (scores.performance < 50) {
      pts.push({ level: 'critical', cat: 'Speed ‚Äî Critical',
        text: `Their site scored ${scores.performance}/100 for performance ‚Äî Google classifies this as "poor". With an LCP of ${vitals.lcpDisplay}, most mobile visitors are waiting over 4 seconds for the main content to appear. Industry data shows 53% of mobile users abandon a page that takes longer than 3 seconds to load.` });
    } else if (scores.performance < 80) {
      pts.push({ level: 'high', cat: 'Speed ‚Äî Needs Work',
        text: `Performance score of ${scores.performance}/100 ‚Äî below the 90+ threshold Google rewards. Mobile visitors are experiencing unnecessary delays that are costing enquiries. This is fully fixable.` });
    }

    // SEO score
    if (scores.seo < 75) {
      pts.push({ level: 'critical', cat: 'SEO ‚Äî Significant Issues',
        text: `Their SEO score is ${scores.seo}/100. Google cannot properly understand or rank this site. Several technical fixes are needed before the site can compete for the first page.` });
    } else if (scores.seo < 90) {
      pts.push({ level: 'high', cat: 'SEO ‚Äî Improvable',
        text: `SEO score of ${scores.seo}/100. There are clear technical gaps that are limiting their Google rankings ‚Äî fixable without a full rebuild in some cases.` });
    }

    // Specific issues
    if (!issues.metaDesc) {
      pts.push({ level: 'high', cat: 'Search Appearance',
        text: 'No meta description ‚Äî Google is writing their own search listing snippet, usually with random text from the page. They have no control over what potential customers read before clicking.' });
    }
    if (!issues.imageAlt) {
      pts.push({ level: 'medium', cat: 'Image SEO',
        text: `${issues.imageAltCount || 'Multiple'} images have no alt text. These are invisible to Google ‚Äî no Google Images traffic, and a missed ranking signal for every product or service photo on the page.` });
    }
    if (!issues.structuredData) {
      pts.push({ level: 'medium', cat: 'Rich Results',
        text: 'No structured data (Schema markup). This means no star ratings, business hours, or rich snippets in Google ‚Äî competitor sites with Schema can appear more prominent in the same search results.' });
    }
    if (!issues.renderBlocking) {
      pts.push({ level: 'high', cat: 'Load Speed',
        text: 'Render-blocking resources are delaying the first paint of the page. Visitors see a blank screen for longer than necessary ‚Äî a known cause of high bounce rates on mobile.' });
    }
    if (!issues.textCompression) {
      pts.push({ level: 'medium', cat: 'File Size',
        text: 'No text compression enabled. Pages are being served at full file size instead of compressed ‚Äî unnecessarily slow on mobile connections.' });
    }
    if (!issues.robotsTxt) {
      pts.push({ level: 'medium', cat: 'Crawl Configuration',
        text: 'No robots.txt file. Google has no crawl guidance for this site ‚Äî a basic technical gap that every properly-set-up site should have.' });
    }
    if (!issues.httpsOk) {
      pts.push({ level: 'critical', cat: 'Security',
        text: 'The site is not on HTTPS. Google marks non-HTTPS sites as "Not Secure" in Chrome ‚Äî a trust flag that visibly puts visitors off before they even read the page.' });
    }

    tp.innerHTML = pts.length
      ? pts.map(p => `
          <div class="tp-item ${p.level}">
            <div class="tp-cat">${p.cat}</div>
            <div class="tp-text" style="white-space:pre-line">${p.text}</div>
          </div>`).join('')
      : '<p style="color:#64748b;font-size:.88rem">No major issues found ‚Äî this site is in reasonable shape.</p>';

    // Strategy note
    const failCount = Object.values({ ...issues }).filter(v => v === false).length;
    const detectedPlatform = pageData?.platform;
    const platformIsWalled = detectedPlatform?.warn === true;

    if (platformIsWalled) {
      sn.style.display = 'block';
      sn.innerHTML = `<strong>üìã Close ‚Äî ${detectedPlatform.name} rebuild angle:</strong>
        "The audit has confirmed this site is on ${detectedPlatform.name}. I want to be straight with you ‚Äî no matter what we do to the current site, ${detectedPlatform.name} has a hard ceiling around 60‚Äì65/100 on mobile. Google uses these scores as a ranking signal, so right now you're structurally disadvantaged versus competitors on faster platforms.
        The only way past that ceiling is a complete rebuild on clean code. We do that for $5,000, live in 2‚Äì4 weeks, and you own it outright ‚Äî no monthly ${detectedPlatform.name} fees, no lock-in, ever."`;
    } else if (scores.performance < 60 || failCount >= 5) {
      sn.style.display = 'block';
      sn.innerHTML = `<strong>üìã Recommended talking point to close:</strong>
        "Based on what I'm seeing here, a Scan & Fix won't be enough ‚Äî there are ${failCount} technical issues and a performance score of ${scores.performance}.
        A Complete Build on a clean foundation will fix all of this in one go. You'll own it outright, no ongoing fees, and we'll have it live in 2‚Äì4 weeks."`;
    } else {
      sn.style.display = 'none';
    }
  }

  // ‚îÄ‚îÄ Copy talking points ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function copyTalkingPoints() {
    const items = document.querySelectorAll('.tp-item');
    const text  = Array.from(items).map(el => {
      const cat  = el.querySelector('.tp-cat')?.textContent ?? '';
      const body = el.querySelector('.tp-text')?.textContent ?? '';
      return `[${cat}]\n${body}`;
    }).join('\n\n');
    navigator.clipboard.writeText(text).then(() => {
      const btn = event.target;
      btn.textContent = '‚úì Copied';
      setTimeout(() => { btn.textContent = 'Copy Talking Points'; }, 2000);
    });
  }

  // ‚îÄ‚îÄ Save / History ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function saveAudit() {
    if (!lastAudit) return;
    const pkg        = document.getElementById('pkg-rec').value;
    const confidence = document.getElementById('confidence').value;
    const notes      = document.getElementById('call-notes').value;
    const email      = document.getElementById('prospect-email').value;
    const entry = { ...lastAudit, pkg, confidence, notes, email, savedAt: Date.now() };
    const history = getHistory();
    // Remove if URL already saved, then prepend
    const filtered = history.filter(h => h.url !== entry.url);
    filtered.unshift(entry);
    localStorage.setItem('iy_audits', JSON.stringify(filtered.slice(0, 30)));
    document.getElementById('save-confirm').style.display = 'inline';
    renderHistory();
  }

  function getHistory() {
    try { return JSON.parse(localStorage.getItem('iy_audits') || '[]'); }
    catch { return []; }
  }

  function renderHistory() {
    const history = getHistory();
    const section = document.getElementById('history-section');
    const list    = document.getElementById('history-list');
    if (!history.length) { section.style.display = 'none'; return; }
    section.style.display = 'block';
    list.innerHTML = history.map((h, i) => {
      const sc = (s, label) => {
        const cls = s >= 90 ? 'hs-green' : s >= 50 ? 'hs-amber' : 'hs-red';
        return `<span class="hs ${cls}">${label} ${s}</span>`;
      };
      return `
        <div class="history-item" onclick="loadHistory(${i})">
          <div>
            <div class="history-url">${h.url}</div>
            <div class="history-meta">${h.area || ''}${h.biz ? ' ¬∑ ' + h.biz : ''} ¬∑ ${h.date || ''}</div>
          </div>
          <div class="history-scores">
            ${sc(h.scores.performance, 'Perf')}
            ${sc(h.scores.seo, 'SEO')}
          </div>
          <button class="btn-del" onclick="deleteHistory(event, ${i})" title="Delete">√ó</button>
        </div>`;
    }).join('');
  }

  function loadHistory(i) {
    const h = getHistory()[i];
    if (!h) return;
    document.getElementById('url-input').value  = h.url;
    document.getElementById('area-input').value = h.area  || '';
    document.getElementById('biz-input').value  = h.biz   || '';
    alert(`History loaded for ${h.url}\n\nClick "Run Audit ‚Üí" to re-run a fresh scan.`);
  }

  function deleteHistory(e, i) {
    e.stopPropagation();
    const history = getHistory();
    history.splice(i, 1);
    localStorage.setItem('iy_audits', JSON.stringify(history));
    renderHistory();
  }

  // ‚îÄ‚îÄ Implement Changes ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function openImplement() {
    if (!lastAudit) return;
    // Store everything fix.html needs
    const fixData = {
      url:      lastAudit.url,
      biz:      lastAudit.biz,
      area:     lastAudit.area,
      scores:   lastAudit.scores,
      vitals:   lastAudit.vitals,
      issues:   lastAudit.issues,
      pageData: _lastPageData || null,
    };
    sessionStorage.setItem('iy_audit_fix', JSON.stringify(fixData));
    window.open('fix.html', '_blank');
  }

  // ‚îÄ‚îÄ Enter key on form ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  ['url-input', 'area-input', 'biz-input'].forEach(id => {
    document.getElementById(id).addEventListener('keydown', e => {
      if (e.key === 'Enter') runAudit();
    });
  });
</script>

</body>
</html>
